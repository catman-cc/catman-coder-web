import IconCN from "@/components/Icon"
import { ExecutorJoinCode } from "@/services/JoinCode/typeings"
import { Button, Collapse, DatePicker, Divider, Input, InputNumber, InputProps, Popconfirm, Select, Space, Switch, Tag, Tooltip, message } from "antd"
import locale from 'antd/es/date-picker/locale/zh_CN'
import Paragraph from "antd/es/typography/Paragraph"
import { ReactNode, useEffect, useState } from "react"

import { IpsEditor } from "@/components/Common/IpsEditor"
import { ExecutorJoinCodeService, ExecutorJoinCodeStatus } from "@/services/JoinCode"
import { CaretRightOutlined } from "@ant-design/icons"
import 'dayjs/locale/zh-cn'
import { ExecutorJoinStatusTag } from "../Status"
import "./index.less"

export interface ExecutorJoinCodeEditorProps {
    data: ExecutorJoinCode,
    onChange?(data: ExecutorJoinCode): void
    simple?: boolean,
    parentNodesDoNotSynchronizeData?: boolean
}

export const ExecutorJoinCodeEditor = ({
    data, onChange, simple = true, parentNodesDoNotSynchronizeData = false
}: ExecutorJoinCodeEditorProps) => {
    const [joinCode, setJoinCode] = useState<ExecutorJoinCode>(data)
    const [editting, setEditting] = useState<{ [index: string]: boolean }>({})
    const [refrenceOption, setRefrenceOption] = useState<{
        keepValiad: boolean,
        reason: string
    }>({
        keepValiad: true,
        reason: ""
    })
    useEffect(() => {
        setJoinCode(data)
    }, [data])


    const update = (code?: ExecutorJoinCode) => {
        if (onChange) {
            onChange({ ...(code || joinCode) })
            if (parentNodesDoNotSynchronizeData) {
                setJoinCode({ ...(code || joinCode) })
            }
        } else {
            setJoinCode({ ...(code || joinCode) })
        }
    }

    return <div className="executor-join-code-editor">
        <div className="executor-join-code-editor-line">
            <div>
                <Paragraph
                    className="labeled"
                    copyable={
                        {
                            text: joinCode.id
                        }
                    }
                >
                    <div>
                        id:
                    </div>
                    <div>
                        <Tag>
                            {joinCode.id}
                        </Tag>
                    </div>

                </Paragraph>
            </div>

        </div>
        <div className="executor-join-code-editor-line">
            <div>
                <EditorInput
                    editName="name"
                    labelFor="ÂêçÁß∞:"
                    placeholder="‰∏∫Êé•ÂÖ•Á†ÅÊèê‰æõ‰∏Ä‰∏™ÂêçÁß∞Âêß"
                    editable={editting}
                    forceEdit={simple}
                    updateEditable={(e) => {
                        setEditting(e)
                    }}
                    copyText={joinCode.name}
                    value={joinCode.name}
                    size="small"
                    width={200}
                    onChange={(e) => {
                        joinCode.name = e.target.value
                        update(joinCode)
                    }}
                />
            </div>
            <div className="flex">
                <EditorInput
                    editName="code"
                    labelFor="Êé•ÂÖ•Á†Å:"
                    editable={editting}
                    updateEditable={(e) => {
                        setEditting(e)
                    }}
                    copyText={joinCode.code}
                    value={joinCode.code}
                    size="small"
                    width={200}
                    onChange={(e) => {
                        joinCode.code = e.target.value
                        update(joinCode)
                    }}
                />

                <Tooltip
                    title="Âà∑Êñ∞Êé•ÂÖ•Á†Å"
                >
                    <Popconfirm
                        title="ËØ∑Ë∞®ÊÖéÊìç‰Ωú"
                        description={
                            <div
                                style={
                                    {
                                        width: "250px"
                                    }
                                }
                            >
                                <div>
                                    <Space>
                                        ‰ΩúÂ∫üÂΩìÂâçÊé•ÂÖ•Á†Å:<Switch size="small" value={!refrenceOption.keepValiad} onChange={v => {
                                            setRefrenceOption({
                                                ...refrenceOption,
                                                keepValiad: !v
                                            })
                                        }} />
                                    </Space>
                                </div>
                                {refrenceOption.keepValiad
                                    ? <div>
                                        Êú¨Ê¨°Êìç‰ΩúÂ∞Ü‰ºö‰∏∫ÊóßÁöÑÊé•ÂÖ•Á†ÅÂàõÂª∫‰∏Ä‰∏™ÂâØÊú¨,ÁªßÁª≠Êèê‰æõÂ∑•‰Ωú
                                    </div>
                                    : <div>
                                        <Space>
                                            Â∫üÂºÉÂéüÂõ†:<Input
                                                size="small"
                                                value={refrenceOption.reason}
                                                onChange={(e) => {
                                                    setRefrenceOption({
                                                        ...refrenceOption,
                                                        reason: e.target.value
                                                    })
                                                }}
                                            />
                                        </Space>
                                    </div>}
                            </div>
                        }
                        onConfirm={() => {
                            const willFlushJoinCode: ExecutorJoinCode = {
                                ...joinCode,
                                invalid: !refrenceOption.keepValiad,
                                invalidReason: refrenceOption.reason
                            }
                            ExecutorJoinCodeService.flushJoinCode(willFlushJoinCode).then((res) => {
                                if (res.success) {
                                    message.success("Êé•ÂÖ•Á†ÅÂà∑Êñ∞ÊàêÂäü")
                                    update(res.data)
                                }
                            })
                        }}
                        okButtonProps={{
                            danger: true,
                            size: "small"
                        }}
                        okText="Âà∑Êñ∞"
                        cancelText="ü§îÊàëÂÜçÊÉ≥ÊÉ≥"
                    >
                        <Button
                            size="small"
                            type="text"
                            shape="circle"
                            icon={
                                <IconCN type="icon-tubiaozhizuomoban"
                                    color="red"
                                    style={{
                                        color: "red"
                                    }}
                                />
                            }
                            onClick={() => {

                            }}
                        />
                    </Popconfirm>
                </Tooltip>
            </div>
        </div>
        <div className="executor-join-code-editor-line">
            <div className="labeled">
                <div>
                    Áä∂ÊÄÅ:
                </div>
                <div>
                    <ExecutorJoinStatusTag
                        status={joinCode.status!}
                    />
                    {joinCode.status === ExecutorJoinCodeStatus.WAIT_ACTIVE && (
                        <Tooltip
                            title="ÁÇπÂáªÊøÄÊ¥ª,ËÆ∞Âæó‰øùÂ≠ò"
                        >
                            <Button size="small"
                                shape="circle"
                                type="text"
                                icon={
                                    <IconCN type="icon-quanxian" />
                                }
                                onClick={() => {
                                    joinCode.status = ExecutorJoinCodeStatus.VALID
                                    update(joinCode)
                                }}
                            />
                        </Tooltip>
                    )}
                    {/* <Tag >{joinCode.status}</Tag> */}
                </div>
            </div>
            {
                joinCode.invalid && (
                    <div className="labeled">
                        <div>
                            Â§±ÊïàÂéüÂõ†:
                        </div>
                        <div>
                            {joinCode.invalidReason}
                        </div>
                    </div>
                )
            }
            <div className="labeled">
                <div>
                    Á±ªÂûã:
                </div>
                <div>
                    <Select
                        size="small"
                        mode="tags"
                        popupMatchSelectWidth={false}
                        value={joinCode.supportedKinds}
                        options={[
                            {
                                key: "executor",
                                label: "ÊâßË°åÂô®",
                                value: "executor",
                                icon: "icon-yunhang1"
                            },
                            {
                                key: "worker",
                                label: "ËäÇÁÇπ",
                                value: "worker",
                                icon: "icon-diannao1"
                            },
                            {
                                key: "schedule",
                                label: "Ë∞ÉÂ∫¶Âô®",
                                value: "schedule",
                                icon: "icon-Recycle"
                            }
                        ]}
                        optionRender={(option) => {
                            return (
                                <Space>
                                    <IconCN type={option.data.icon} />
                                    <span>{`${option.label}(${option.value})`}</span>
                                </Space>
                            )
                        }}
                        onSelect={(v, o) => {
                        }}
                        onChange={(v, o) => {
                            joinCode.supportedKinds = v
                            update(joinCode)
                        }}
                    />
                </div>
            </div>
        </div>
        <Divider />
        <div>
            <IpsEditor ips={[
                ...joinCode.ipFilter || []
            ]}
                onUpdate={(ips) => {
                    joinCode.ipFilter = ips
                    update()
                }}
            />
        </div>
        <Divider />
        <div className="executor-join-code-editor-line">
            <div className="labeled">
                <span>
                    ÊòØÂê¶ÊîØÊåÅÈáçÂ§çÊé•ÂÖ•:
                </span>
                <div style={{
                    height: "1em",
                    alignItems: "baseline"
                }}>
                    <Switch size="small"
                        value={joinCode.repeatable}
                        onChange={(v) => {
                            joinCode.repeatable = v
                            update()
                        }}
                    />
                </div>
            </div>
        </div>
        <div className="executor-join-code-editor-line">
            <div className="labeled">
                <span>
                    ÊòØÂê¶ÈôêÂà∂Êé•ÂÖ•Êó∂Èó¥:
                </span>
                <div style={{
                    height: "1em",
                    alignItems: "baseline"
                }}>
                    <Switch size="small"
                        value={joinCode.limitAccessTime}
                        onChange={(v) => {
                            joinCode.limitAccessTime = v
                            update()
                        }}
                    />
                </div>
            </div>
        </div>
        <div className="labeled">
            {/* ÈôêÂà∂ËÆøÈóÆÊó∂Èó¥ */}
            <span>
                ÊòØÂê¶ÈôêÂà∂Êé•ÂÖ•IPÊ±†:
            </span>
            <div style={{
                height: "1em",
                alignItems: "baseline"
            }}>
                <Switch size="small"
                    value={joinCode.limitAccessIps}
                    onChange={(v) => {
                        joinCode.limitAccessIps = v
                        update()
                    }}
                />
            </div>
        </div>
        <div>
            <Collapse
                size="small"
                bordered={false}
                expandIcon={({ isActive }) => <CaretRightOutlined rotate={isActive ? 90 : 0} />}
                items={[
                    {
                        key: "limit-repeatable",
                        label: "ÈôêÂà∂ÈáçÂ§çËÆøÈóÆ",
                        children: <div style={{
                            marginLeft: "18px"
                        }}>
                            <div className="labeled">
                                <div>
                                    ÊúÄÂ§ßÈáçÂ§çÊé•ÂÖ•Ê¨°Êï∞:
                                </div>
                                <div>
                                    <InputNumber
                                        size="small"
                                        type="number"
                                    />
                                </div>
                            </div>
                        </div>

                    },
                    {
                        key: "limit-access-time",
                        label: "ÈôêÂà∂ËÆøÈóÆÊó∂Èó¥",
                        children:

                            <div>
                                <div className="executor-join-code-editor-line">
                                    <div className="labeled">
                                        <span>
                                            ÊåáÂÆöÊó∂Èó¥‰πãÂêé<span
                                                style={{
                                                    color: "green"
                                                }}
                                            >ÂÖÅËÆ∏</span>Êé•ÂÖ•:
                                        </span>
                                        <div style={{
                                            height: "1em",
                                            alignItems: "baseline"
                                        }}>
                                            <DatePicker showTime size="small" locale={locale} />
                                        </div>
                                    </div>
                                </div>

                                <div className="executor-join-code-editor-line">
                                    <div className="labeled">
                                        <span>
                                            ÊåáÂÆöÊó∂Èó¥‰πãÂêé<span
                                                style={{
                                                    color: "red"
                                                }}
                                            >Á¶ÅÊ≠¢</span>Êé•ÂÖ•:
                                        </span>
                                        <div style={{
                                            height: "1em",
                                            alignItems: "baseline"
                                        }}>
                                            <DatePicker showTime size="small" locale={locale} />
                                        </div>
                                    </div>
                                </div>
                                Âë®ÊúüÊÄßËÆøÈóÆÈôêÂà∂,ÊØèÊúà,ÈÄâÊã©,ÊØèÂπ¥,ÊØèÂë®,ÊØèÂ§©,Â§ö‰∏™Áª¥Â∫¶ÈôêÂà∂
                                <div>
                                    <div className="executor-join-code-editor-line">
                                        <div className="labeled">
                                            <span>
                                                ÊåáÂÆöÊó∂Èó¥‰πãÂêé<span
                                                    style={{
                                                        color: "green"
                                                    }}
                                                >ÂÖÅËÆ∏</span>Êé•ÂÖ•:
                                            </span>
                                            <div style={{
                                                height: "1em",
                                                alignItems: "baseline"
                                            }}>
                                                <DatePicker showTime size="small" locale={locale} />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="executor-join-code-editor-line">
                                        <div className="labeled">
                                            <span>
                                                ÊåáÂÆöÊó∂Èó¥‰πãÂêé<span
                                                    style={{
                                                        color: "red"
                                                    }}
                                                >Á¶ÅÊ≠¢</span>Êé•ÂÖ•:
                                            </span>
                                            <div style={{
                                                height: "1em",
                                                alignItems: "baseline"
                                            }}>
                                                <DatePicker showTime size="small" locale={locale} />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                    },
                    {
                        key: "limit-access-ip",
                        label: "ÈôêÂà∂ËÆøÈóÆIP",
                        children: <div>
                            <IpsEditor ips={[]} />
                        </div>

                    },
                    {
                        key: "settings-for-executor",
                        label: "ÊâßË°åÂô®ËÆæÁΩÆ",
                        children: <div>
                            Â¶ÇÊûúËß£Á†ÅÁ±ªÂûã‰∏≠ÂåÖÂê´‰∫ÜÊâßË°åÂô®,ÂèØ‰ª•Ëøõ‰∏ÄÊ≠•ÈôêÂà∂:
                            <ul>
                                <li>
                                    Âè™ÂÖÅËÆ∏ÁâπÂÆöÊìç‰ΩúÁ≥ªÁªü,ÁâπÂÆöbitNess,ÁâπÂÆölanguageÁöÑÊâßË°åÂô®Êé•ÂÖ•
                                </li>
                                <li>
                                    ÈÖçÁΩÆ‰ªªÂä°Ë∞ÉÂ∫¶Á≠ñÁï•,ÊØîÂ¶Ç:Á¶ÅÊ≠¢Ë∞ÉÂ∫¶ÈùûÂΩìÂâçÁî®Êà∑ÁöÑ‰ªªÂä°Âà∞ÊâßË°åÂô®,(ÈúÄË¶ÅÂÆåÂñÑÁî®Êà∑Á≥ªÁªü)
                                </li>
                                <li>
                                    ÈÖçÁΩÆÊ†∏ÂøÉËµÑÊ∫êËÆøÈóÆÊùÉÈôê,ÊØîÂ¶Ç,Âú®ÊâßË°å‰ªªÂä°Êó∂,ÂèØ‰ª•‰ΩøÁî®ÊüêÁâπÂÆöÁî®Êà∑Êù•ÊâßË°å‰ªªÂä°
                                </li>
                            </ul>
                        </div>

                    },
                    {
                        key: "settings-for-schedule",
                        label: "Ë∞ÉÂ∫¶Âô®ËÆæÁΩÆ",
                        children: <div>
                            Â¶ÇÊûúÊé•ÂÖ•Á†ÅÁ±ªÂûãÂåÖÂê´‰∫ÜSchedule,ÂèØ‰ª•Ëøõ‰∏ÄÊ≠•ÈôêÂà∂:
                            <ul>
                                <li>
                                    Âè™ÂÖÅËÆ∏Âè™ÂÖÅËÆ∏ÁâπÂÆöÊìç‰ΩúÁ≥ªÁªü,ÁâπÂÆöbitNess,ÁâπÂÆölanguageÁöÑÊâßË°åÂô®Êé•ÂÖ•
                                </li>
                                <li>
                                    ‰∏∫scheduleÊ∑ªÂä†Ê†áÁ≠æËøáÊª§Êú∫Âà∂,ËøáÊª§‰ªªÂä°,ÂÖ∂ÁõÆÁöÑÊòØËÆ©ÁâπÂÆöÁöÑscheduleÂè™Ë∞ÉÂ∫¶‰∏Ä‰∫õÁâπÂÆöÁöÑ‰ªªÂä°
                                </li>
                                <li>
                                    ÈÖçÁΩÆscheduleÁöÑËÆøÈóÆÊùÉÈôê,ÊØîÂ¶Ç,Êé•ÂÖ•Âêé,ÈªòËÆ§Êã•ÊúâÊüê‰∏Ä‰∏™Áî®Êà∑ÁöÑÊùÉÈôê
                                </li>
                            </ul>
                        </div>

                    },
                    {
                        key: "settings-for-runner",
                        label: "ËøêË°åËäÇÁÇπËÆæÁΩÆ",
                        children: <div>
                            Â¶ÇÊûúÊé•ÂÖ•Á†ÅÂåÖÂê´‰∫ÜWorker,ÂèØ‰ª•Ëøõ‰∏ÄÊ≠•ÈôêÂà∂:
                            <ul>
                                <li>
                                    Âè™ÂÖÅËÆ∏Âè™ÂÖÅËÆ∏ÁâπÂÆöÊìç‰ΩúÁ≥ªÁªü,ÁâπÂÆöbitNess,ÁâπÂÆölanguageÁöÑÊâßË°åÂô®Êé•ÂÖ•
                                </li>
                                <li>
                                    ÈÖçÁΩÆÊ†∏ÂøÉËµÑÊ∫êËÆøÈóÆÊùÉÈôê,ÊØîÂ¶Ç,Âú®ÊâßË°å‰ªªÂä°Êó∂,ÂèØ‰ª•‰ΩøÁî®ÊüêÁâπÂÆöÁî®Êà∑Êù•ÊâßË°å‰ªªÂä°
                                </li>
                            </ul>
                        </div>

                    },
                ]}
            />
        </div>
        Â±ïÁ§∫ id
        Â±ïÁ§∫ÂêçÁß∞
        Â±ïÁ§∫Áä∂ÊÄÅ
        Â±ïÁ§∫Êé•ÂÖ•Á†ÅÁ±ªÂûã
        Â±ïÁ§∫Â∑≤Êé•ÂÖ•Á†Å,Êèê‰æõ‰∏Ä‰∏™Âà∑Êñ∞ÊåâÈíÆ,ÂèØ‰ª•Ëá™ÂÆö‰πâÊé•ÂÖ•Á†Å
        Êèê‰æõÁ¶ÅÁî®ÂêØÁî®ÊåâÈíÆ
        ÊîØÊåÅÊòØÂê¶ÈáçÂ§çÊé•ÂÖ•ÂºÄÂÖ≥
        ÂΩìÂêØÁî®ÈáçÂ§çÂºÄÂÖ≥Êó∂,ÊîØÊåÅËÆæÁΩÆÊúÄÂ§ßÈáçÂÖ•Ê¨°Êï∞
        Êèê‰æõ‰∏Ä‰∏™ËæìÂÖ•Ê°Ü,ÂÖÅËÆ∏ËæìÂÖ•ËÆøÈóÆÊó∂Èó¥ÈôêÂà∂,ÂΩìËææÂà∞ÈôêÂà∂Ëá™Âä®Êñ≠ÂºÄ
        ÈôêÂà∂Êé•ÂÖ•ÁöÑÊó∂Èó¥ËåÉÂõ¥,Ëµ∑Ê≠¢Êó∂Èó¥
        Êèê‰æõ‰∏Ä‰∏™ÂèØÁºñËæëÂàóË°®,ÂÖÅËÆ∏ÈÖçÁΩÆÂèØËÆøÈóÆipÂíåÁ¶ÅÁî®idÂú∞ÂùÄ,ÊîØÊåÅÂú∞ÂùÄÊÆµ,Ëß£ÊûêÊó∂ÊåâÁÖßÂÆö‰πâÈ°∫Â∫èÂ§ÑÁêÜ.
        ÂåπÈÖç‰ªªÊÑè‰∏Ä‰∏™ÁôΩÂêçÂçïÂç≥ÊîæË°å,ÊàñËÄÖ‰∏çÂåπÈÖç‰ªª‰ΩïÈªëÂêçÂçï

    </div>
}

export const EditorInput = (props: {
    editName: string,
    editable: { [index: string]: boolean },
    updateEditable: (_editable: { [index: string]: boolean }) => void
    labelFor?: string | ReactNode
    copyText?: string
    forceEdit?: boolean
} & InputProps) => {
    return (
        <div className="executor-join-code-editor-labeled-input">
            <Paragraph
                className="labeled"
                copyable={props.copyText ? {
                    text: props.copyText
                } : false}
            >
                <div>
                    {props.labelFor ? props.labelFor : null}
                </div>
                <Input
                    style={
                        {
                            width: "auto"
                        }
                    }
                    {...props}
                    disabled={(!props.forceEdit && !props.editable[props.editName])}
                    size="small"
                    addonAfter={
                        !props.forceEdit && (
                            <IconCN type={props.editable[props.editName] ? "icon-save" : "icon-editor-line"}
                                onClick={() => {
                                    props.editable[props.editName] = !props.editable[props.editName]
                                    props.updateEditable({
                                        ...props.editable,
                                    })
                                }}
                            />
                        )
                    }
                />

            </Paragraph>
        </div>
    )
}